#### 简介

所谓幂等性就是一次和多次请求某一个资源应该具有同样的副作用

用数学的语言来表达就是：f(x) = f(f(x))。比如，求绝对值的函数，abs(x) = abs(abs(x))

幂等性的含义是，一个调用被发送多次所产生的副作用和被发送一次所产生的副作用是一样的。而服务调用有三种结果：成功、失败和超时，其中超时是我们需要解决的问题

解决手段可以是超时后查询调用结果，也可以是在被调用的服务中实现幂等性，为了在分布式系统中实现幂等性，我们通常需要实现全局 ID

可参考 Twitter 的开源项目 Snowflake，它是一个分布式 ID 的生成算法

#### 处理流程

我们需要一个存储来记录收到的交易，当收到交易请求的时候，我们就会到这个存储中去查询。如果查找到了，那么就不再做查询了，并把上次做的结果返回。如果没有查到，那么我们就记录下来

因为绝大多数请求应该都不会是重新发过来的，所以让 100% 的请求都到这个存储里去查一下，这会导致处理流程变得很慢，可以在设置交易表的时候设置唯一索引，或修改sql:
```
insert into … values … on DUPLICATE KEY UPDATE
```

ON DUPLICATE KEY UPDATE 的意思就是当数据库中存在某个记录时，执行这个语句会更新，而不存在这条记录时，就会插入

#### HTTP 的幂等性

- 在表单中需要隐藏一个 token，这个 token 是表单的唯一标识，后端检查 token 是否为重复提交

- 前端控制表单提交按钮，需要等待后端响应或超时后才可以恢复

- 后端成功后向前端返回 302 跳转，前端最好还需要把之前的表单设置成过期，这样用户不能通过浏览器后退按钮来重新提交



#### 简介

在开发中为了降低单点压力，通常会根据业务情况进行分表分库，将表分布在不同的库中（库可能分布在不同的机器上）。在这种场景下，事务的提交会变得相对复杂，因为多个节点（库）的存在，可能存在部分节点提交失败的情况，即事务的ACID特性需要在各个不同的数据库实例中保证。比如更新db1库的A表时，必须同步更新db2库的B表，两个更新形成一个事务，要么都成功，要么都失败

参考mysql5.7手册：

https://dev.mysql.com/doc/refman/5.7/en/xa.html


- 资源管理器（resource manager）

用来管理系统资源，是通向事务资源的途径。数据库就是一种资源管理器。资源管理还应该具有管理事务提交或回滚的能力


- 事务管理器（transaction manager）

事务管理器是分布式事务的核心管理者。事务管理器与每个资源管理器（resource manager）进行通信，协调并完成事务的处理。事务的各个分支由唯一命名进行标识


mysql在执行分布式事务（外部XA）的时候，mysql服务器相当于xa事务资源管理器，与mysql链接的客户端相当于事务管理器


#### 实现

1、分布式事务原理：分段式提交

分布式事务通常采用2PC协议，全称Two Phase Commitment Protocol。该协议主要为了解决在分布式数据库场景下，所有节点间数据一致性的问题

分布式事务通过2PC协议将提交分成两个阶段：

- 阶段一为准备（prepare）阶段：

即所有的参与者准备执行事务并锁住需要的资源,参与者ready时，向transaction manager报告已准备就绪

- 阶段二为提交（commit）阶段：

当transaction manager确认所有参与者都ready后，向所有参与者发送commit命令


2、配置

```
SHOW VARIABLES LIKE '%xa%'

SET innodb_support_xa = ON
```

3、外部XA用于跨多MySQL实例的分布式事务，需要应用层作为协调者：

```
//为XA事务指定一个id，xid 必须是一个唯一值。
$xid = uniqid("");

//两个库指定同一个事务id，表明这两个库的操作处于同一事务中
$dbtest1->query("XA START '$xid'");//准备事务1
$dbtest2->query("XA START '$xid'");//准备事务2

//执行更新操作
$ret = true;

//阶段1：$dbtest1提交准备就绪
$dbtest1->query("XA END '$xid'");
$dbtest1->query("XA PREPARE '$xid'");
//阶段1：$dbtest2提交准备就绪
$dbtest2->query("XA END '$xid'");
$dbtest2->query("XA PREPARE '$xid'");

//阶段2：提交两个库
$dbtest1->query("XA COMMIT '$xid'");
$dbtest2->query("XA COMMIT '$xid'");

 //阶段2：回滚（更新操作抛出异常）
 $dbtest1->query("XA ROLLBACK '$xid'");
$dbtest2->query("XA ROLLBACK '$xid'");
```